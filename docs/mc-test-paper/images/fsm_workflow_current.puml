@startuml
' Erzwingt vertikale Orientierung von oben nach unten
top to bottom direction

skinparam state {
  BackgroundColor White
  BorderColor Black
  ArrowColor Black
  FontName Arial
  FontSize 13
}
skinparam note {
  BackgroundColor LightYellow
  BorderColor Gray
}

state "Phase 1: Interactive Configuration (Sequential Steps)" as Interaction {
  state "Step 1: Define Topic\n(Subject Area)" as Step1
  state "Step 2: Define Target Audience" as Step2
  state "Step 3: Set Question Count\n& Difficulty Distribution" as Step3
  state "Step 4: Answer Format\n(4, 5, or Variable 3-5)" as Step4
  state "Step 5: Provide Context Material\n(Uploads/RAG or 'no')" as Step5
  state "Review & Confirmation\n(Summary)" as Confirm

  [*] -down-> Step1
  Step1 -down-> Step2 : <b>Topic Locked</b>
  Step2 -down-> Step3 : <b>Audience Set</b>
  Step3 -down-> Step4 : <b>Counts Balanced</b>
  Step4 -down-> Step5 : <b>Format Fixed</b>
  Step5 -down-> Confirm : <b>Context Processed</b>

  Step1 -right-> Step1 : [Clarify Ambiguity]
  Step2 -right-> Step2 : [Refine Level]
  Step3 -right-> Step3 : [Fix Count/Weights]
  Step4 -right-> Step4 : [Invalid Selection]
  Step5 -right-> Step5 : [Retry Upload]

  Confirm -up-> Step1 : User requests Revision
}

state "Phase 2: Deterministic Generation" as Generation_Phase {
  state "Blueprinting\n(Count, Topics, Difficulty)" as Blueprinting
  state "Drafting\n(Questions & Options)" as Drafting
  state "Context Integration\n(if provided)" as Context
  state "Validation & Auto-Fix\n(JSON, math, glossary)" as Validate
  state "Final JSON Output" as JsonOut

  Blueprinting -down-> Drafting : <b>Plan Verified</b>
  Drafting -down-> Context : <b>Context Provided</b>
  Drafting -right-> Validate : [No external context]
  Context -down-> Validate : <b>Integrated</b>
  Validate -down-> JsonOut : <b>All checks pass</b>
  Validate -right-> Validate : [Auto-fix & re-validate]
}

Confirm -down-> Generation_Phase : <b>User Confirms ("Yes")</b>
JsonOut -down-> [*] : Terminate

note right of Step3
  <b>Constraints:</b>
  - Max 30 questions
  - Weights 1-3 sum to total
end note

note right of Validate
  <b>Deterministic rules:</b>
  - options: 3-5, answer valid
  - mini_glossary: 2-4 entries
  - extended_explanation: null for weight 1
  - JSON-escaped LaTeX
  - No references to provided docs
end note

@enduml
