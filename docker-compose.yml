services:
  # Jupyter Lab Environment für Lehrer-Präsentationen
  jupyter-lab:
    build:
      context: .
      dockerfile: Dockerfile.jupyter
    ports:
      - "8888:8888"
    volumes:
      - ./:/workspace
      - jupyter-data:/home/jovyan/.jupyter
    environment:
      - JUPYTER_ENABLE_LAB=yes
      - JUPYTER_TOKEN=
    command: start-notebook.sh --ServerApp.token='' --ServerApp.password='' --ServerApp.allow_remote_access=True

  # Jupyter Lab Slim (kleineres Image, ohne TF/Torch/OpenCV)
  jupyter-lab-slim:
    build:
      context: .
      dockerfile: Dockerfile.jupyter-slim
    ports:
      - "8889:8888"
    volumes:
      - ./:/workspace
    environment:
      - JUPYTER_ENABLE_LAB=yes
    command: start-notebook.sh --ServerApp.token='' --ServerApp.password='' --ServerApp.allow_remote_access=True

  # Streamlit Development Environment für Studierende
  streamlit-dev:
    build:
      context: .
      dockerfile: Dockerfile.streamlit
    ports:
      - "8501:8501"
    volumes:
      - ./:/app
    environment:
      STREAMLIT_SERVER_PORT: "8501"
      STREAMLIT_SERVER_ADDRESS: "0.0.0.0"
      MC_TEST_ADMIN_KEY: "${MC_TEST_ADMIN_KEY:-}"
  command: streamlit run /app/mc_test_app/mc_test_app.py

  # Streamlit Slim (schneller Start, kleineres Image)
  streamlit-slim:
    build:
      context: .
      dockerfile: Dockerfile.streamlit-slim
    ports:
      - "8502:8501"
    volumes:
      - ./:/app
    environment:
      STREAMLIT_SERVER_PORT: "8501"
      STREAMLIT_SERVER_ADDRESS: "0.0.0.0"
      MC_TEST_ADMIN_KEY: "${MC_TEST_ADMIN_KEY:-}"
  command: streamlit run /app/mc_test_app/mc_test_app.py

  # MLflow Tracking Server für Experiment Management
  mlflow:
    image: python:3.11-slim
    ports:
      - "5001:5000"
    volumes:
      - mlflow-data:/mlflow
    command: >
      bash -c "pip install mlflow>=2.4.0 &&
               mlflow server --host 0.0.0.0 --port 5000 --default-artifact-root /mlflow/artifacts --backend-store-uri sqlite:///mlflow/mlflow.db"

  # PostgreSQL für fortgeschrittene Datenbank-Übungen
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: iu_analytics
      POSTGRES_USER: student
      POSTGRES_PASSWORD: data_science_2025
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./datasets:/docker-entrypoint-initdb.d

volumes:
  jupyter-data:
  mlflow-data:
  postgres-data:
